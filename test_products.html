<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Тест загрузки товаров</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <h1>Тест загрузки товаров</h1>
    <div id="productsContainer"></div>

    <script>
        // Глобальные переменные
        window.currentProducts = [];
        window.loadedProductNames = new Set();

        // Функции из app.js
        function generateStars(rating) {
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 >= 0.5;
            const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);

            return '★'.repeat(fullStars) +
                   (hasHalfStar ? '☆' : '') +
                   '☆'.repeat(emptyStars);
        }

        function processProductData(product) {
            let processedProduct = { ...product };

            // Устанавливаем статус наличия если не установлен
            if (!processedProduct.availability) {
                processedProduct.availability = "В наличии";
            }

            // Устанавливаем рейтинг если не установлен
            if (!processedProduct.rating) {
                processedProduct.rating = 4.5;
            }

            // Устанавливаем цены если не установлены
            if (!processedProduct.newPrice && processedProduct.price) {
                processedProduct.newPrice = processedProduct.price;
            }
            if (!processedProduct.price && processedProduct.newPrice) {
                processedProduct.price = processedProduct.newPrice;
            }

            return processedProduct;
        }

        function sortProductsByPolicy(products) {
            return products.sort((a, b) => {
                const priceA = parseFloat(a.price) || parseFloat(a.newPrice) || 0;
                const priceB = parseFloat(b.price) || parseFloat(b.newPrice) || 0;
                return priceA - priceB;
            });
        }

        async function fetchProductDataFromAPI(category = 'electro', start = 0, limit = 60) {
            try {
                console.log('fetchProductDataFromAPI: Получение данных для категории:', category, 'start:', start, 'limit:', limit);
                const apiUrl = `./static_products_clean.json`;
                console.log('fetchProductDataFromAPI: API URL:', apiUrl);

                const response = await fetch(apiUrl);
                console.log('fetchProductDataFromAPI: Response status:', response.status);

                if (!response.ok) {
                    console.error('fetchProductDataFromAPI: Response not ok:', response.status, response.statusText);
                    throw new Error(`Не удалось загрузить данные через API: ${response.status}`);
                }

                const data = await response.json();
                console.log('fetchProductDataFromAPI: Загружены данные через API:', data);

                if (data.products && data.products.length > 0) {
                    let products = data.products;

                    // Фильтруем по категории если нужно
                    if (category !== 'electro' && category !== 'all') {
                        products = products.filter(product => {
                            // Фильтрация по полю category в данных
                            if (product.category) {
                                return product.category === category;
                            }
                            // Альтернативная фильтрация по названию для обратной совместимости
                            const productName = product.name || '';
                            if (category === 'acoustic') return productName.toLowerCase().includes('акустич') || productName.toLowerCase().includes('acoustic');
                            if (category === 'bass') return productName.toLowerCase().includes('бас') || productName.toLowerCase().includes('bass');
                            if (category === 'classic') return productName.toLowerCase().includes('классич') || productName.toLowerCase().includes('classic');
                            if (category === 'electro-09') return product.gauge === '09';
                            if (category === 'electro-10') return product.gauge === '10';
                            if (category === 'electro-11') return product.gauge === '11';
                            return true;
                        });
                    }

                    // Применяем пагинацию
                    const paginatedProducts = products.slice(start, start + limit);
                    console.log('fetchProductDataFromAPI: Возвращаем товары:', paginatedProducts.length, 'из', products.length);

                    return paginatedProducts;
                } else {
                    throw new Error('Нет товаров в ответе API');
                }

            } catch (error) {
                console.warn('fetchProductDataFromAPI: Ошибка загрузки данных через API:', error.message);
                return [];
            }
        }

        function displayProducts(products) {
            console.log('displayProducts: Отображаем товары, количество:', products.length);

            const container = document.getElementById('productsContainer');
            if (!container) {
                console.error('displayProducts: Контейнер #productsContainer не найден');
                return;
            }
            console.log('displayProducts: Контейнер найден:', container);

            let html = '';

            products.forEach((product, index) => {
                const globalIndex = index;
                const productName = (product.name || 'Без названия').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                const productPrice = product.newPrice || product.price || 0;
                const productOldPrice = product.oldPrice || 0;
                const productImage = product.image || './images/Discontinued.jpg';
                const availability = product.availability || 'В наличии';

                const rating = product.rating || (Math.random() * 1.5 + 3.5).toFixed(1);
                const reviewCount = Math.floor(Math.random() * 200 + 10);

                let availabilityClass = 'in-stock';
                let availabilityText = 'В наличии';
                let statusButton = '';

                if (availability === 'Нет в наличии') {
                    availabilityClass = 'out-of-stock';
                    availabilityText = 'Нет в наличии';
                    statusButton = `<button class="btn status-btn out-of-stock">Нет в наличии</button>`;
                } else {
                    statusButton = `<button class="btn add-to-cart-btn" data-index="${globalIndex}">Купить</button>`;
                }

                html += `
                    <div class="product-card">
                        <div class="product-actions">
                            <button class="favorite-btn" data-index="${globalIndex}">
                                <i class="far fa-heart"></i>
                            </button>
                            <button class="compare-btn" data-index="${globalIndex}">
                                <i class="fas fa-balance-scale"></i>
                            </button>
                        </div>
                        <div class="img-container">
                            <img class="img" src="${productImage}" alt="${productName}" onerror="this.src='./images/Discontinued.jpg'" loading="lazy">
                        </div>
                        <div class="product-title">${productName.substring(0, 50)}${productName.length > 50 ? '...' : ''}</div>
                        <div class="product-status ${availabilityClass}">${availabilityText}</div>
                        <div class="product-prices">
                            <div class="new-price">${productPrice > 0 ? productPrice + ' ₴' : 'Цена по запросу'}</div>
                            ${productOldPrice > productPrice && productOldPrice > 0 ? '<div class="old-price">' + productOldPrice + ' ₴</div>' : ''}
                        </div>
                        <div class="product-rating">
                            <div class="stars">
                                ${generateStars(rating)}
                            </div>
                            <span class="rating-value">${rating}</span>
                            <span class="review-count">(${reviewCount})</span>
                        </div>
                        ${statusButton}
                    </div>
                `;
            });

            container.innerHTML = html;
            console.log('displayProducts: HTML вставлен в контейнер, длина HTML:', html.length);

            window.currentProducts = products;
            console.log('displayProducts: Товары отображены успешно, количество:', products.length);
        }

        async function loadProducts() {
            try {
                console.log('loadProducts: Начинаем загрузку товаров');
                const productsData = await fetchProductDataFromAPI('electro', 0, 10);
                console.log('loadProducts: Получено товаров:', productsData.length);

                if (productsData.length > 0) {
                    const processedProducts = productsData.map(product => processProductData(product));
                    console.log('loadProducts: После обработки:', processedProducts.length);

                    const sortedProducts = sortProductsByPolicy(processedProducts);
                    console.log('loadProducts: После сортировки:', sortedProducts.length);

                    displayProducts(sortedProducts);
                } else {
                    console.error('loadProducts: Товары не загружены');
                }
            } catch (error) {
                console.error('loadProducts: Ошибка загрузки товаров:', error);
            }
        }

        // Запускаем загрузку товаров при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Тестовая страница загружена, начинаем загрузку товаров');
            loadProducts();
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Проверка: Nickel Plated Electric Strings</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; margin: 20px; }
        h1 { font-size: 20px; margin-bottom: 10px; }
        .controls { display: flex; gap: 10px; margin: 10px 0 15px; flex-wrap: wrap; }
        button { padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; }
        button:hover { background: #fafafa; }
        .stats, .per-page, .missing, .dups { margin-top: 12px; padding: 12px; border: 1px solid #eee; border-radius: 8px; background: #fff; }
        .ok { color: #2e7d32; }
        .warn { color: #d32f2f; }
        textarea { width: 100%; min-height: 220px; font-family: ui-monospace, Menlo, Consolas, monospace; font-size: 12px; }
        code { background: #f6f8fa; padding: 2px 4px; border-radius: 4px; }
        .small { font-size: 12px; color: #666; }
        .list { white-space: pre-wrap; font-family: ui-monospace, Menlo, Consolas, monospace; font-size: 12px; }
    </style>
    <script>
        function enc(u){return encodeURIComponent(u)}
        const BASE = 'http://localhost:8000/proxy_fetch?url=';
        const SRC_PAGES = [
            'https://guitarstrings.com.ua/electro/nickel-plated-electric',
            'https://guitarstrings.com.ua/electro/nickel-plated-electric?start=60',
            'https://guitarstrings.com.ua/electro/nickel-plated-electric?start=120',
            'https://guitarstrings.com.ua/electro/nickel-plated-electric?start=180',
            'https://guitarstrings.com.ua/electro/nickel-plated-electric?start=240'
        ];

        function normalizeLoose(s){
            return (s||'')
              .toLowerCase()
              .normalize('NFKD')
              .replace(/\s+/g,' ')
              .replace(/[\u2000-\u206F\u2E00-\u2E7F`'"’“”.,:;!~_*+\-—–·•()\[\]{}<>/\\|@#%^&?=]+/g,' ')
              .replace(/\s+/g,' ')
              .trim();
        }

        function parseNamesFromHTML(html){
            const doc = new DOMParser().parseFromString(html, 'text/html');
            const items = Array.from(doc.querySelectorAll('div.spacer, div.product-item, div.item'));
            const names = [];
            for (const item of items){
                const nameEl = item.querySelector('h3.product-title a, h3.title a, h3 a, h2 a, a.title')
                           || item.querySelector('h3.product-title, h3.title, h3, h2, a.title');
                const name = nameEl ? nameEl.textContent.trim().replace(/\s+/g,' ') : '';
                if (name) names.push(name);
            }
            return names;
        }

        async function loadAll(){
            const statusEl = document.getElementById('status');
            const perPageEl = document.getElementById('perPage');
            const outEl = document.getElementById('out');
            const dupsEl = document.getElementById('dups');
            statusEl.textContent = 'Загружаю страницы…';
            perPageEl.innerHTML = '';
            dupsEl.innerHTML = '';

            const all = [];
            const perPageCounts = [];
            for (let i=0;i<SRC_PAGES.length;i++){
                const url = SRC_PAGES[i];
                const res = await fetch(BASE + enc(url), { cache: 'no-store' });
                if (!res.ok){
                    perPageCounts.push({page:i+1, url, ok:false, count:0, code:res.status});
                    continue;
                }
                const html = await res.text();
                const names = parseNamesFromHTML(html);
                perPageCounts.push({page:i+1, url, ok:true, count:names.length});
                all.push(...names);
            }

            // Уникализация и дубликаты (по loose-нормализации)
            const seen = new Set();
            const unique = [];
            const dupMap = new Map();
            for (const n of all){
                const k = normalizeLoose(n);
                if (seen.has(k)){
                    dupMap.set(k, (dupMap.get(k)||[]).concat([n]));
                } else {
                    seen.add(k);
                    unique.push(n);
                }
            }

            // Вывод статистики
            const totalRaw = all.length;
            const totalUnique = unique.length;
            statusEl.innerHTML = `Всего найдено (сырых): <b>${totalRaw}</b> · Уникальных: <b>${totalUnique}</b>`;
            const ppFrag = document.createDocumentFragment();
            perPageCounts.forEach(p => {
                const div = document.createElement('div');
                div.className = 'small';
                div.innerHTML = `${p.ok?'<span class="ok">OK</span>':'<span class="warn">ERR</span>'} · Стр. ${p.page}: <code>${p.url}</code> — найдено: <b>${p.count}</b>${p.ok?'':` (HTTP ${p.code})`}`;
                ppFrag.appendChild(div);
            });
            perPageEl.appendChild(ppFrag);

            // Список для копирования
            outEl.value = unique.join('\n');

            // Дубликаты
            if (dupMap.size){
                const lines = [];
                dupMap.forEach((vals, key) => {
                    const allVals = [unique.find(u => normalizeLoose(u)===key), ...vals];
                    lines.push(`×${allVals.length}: ${allVals.join(' | ')}`);
                });
                dupsEl.innerHTML = `<div><b>Дубликаты (${dupMap.size})</b></div><div class="list">${lines.join('\n')}</div>`;
            } else {
                dupsEl.innerHTML = `<div><b>Дубликатов нет</b></div>`;
            }
        }

        async function copyOut(){
            const outEl = document.getElementById('out');
            try { await navigator.clipboard.writeText(outEl.value); alert('Скопировано в буфер обмена'); }
            catch(e){ alert('Не удалось скопировать автоматически'); }
        }

        window.addEventListener('DOMContentLoaded', () => {
            document.getElementById('runBtn').addEventListener('click', loadAll);
            document.getElementById('copyBtn').addEventListener('click', copyOut);
            // Автостарт
            loadAll();
        });
    </script>
    </head>
<body>
    <h1>Проверка: Nickel Plated Electric Strings</h1>
    <div class="controls">
        <button id="runBtn">Перезагрузить</button>
        <button id="copyBtn">Скопировать список</button>
        <span class="small">Источник: <code>https://guitarstrings.com.ua/electro/nickel-plated-electric</code></span>
    </div>
    <div class="stats" id="status">Ожидание…</div>
    <div class="per-page" id="perPage"></div>
    <div class="stats">
        <div><b>Список уникальных позиций:</b></div>
        <textarea id="out" spellcheck="false"></textarea>
    </div>
    <div class="dups" id="dups"></div>
</body>
</html>



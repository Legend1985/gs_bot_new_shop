<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Проверка: 09 калибр электро</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; }
        h1 { margin-bottom: 10px; }
        .controls { margin: 10px 0 20px; }
        button { background: #007bff; color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; }
        button:disabled { background: #9bbcf0; cursor: default; }
        .card { background: #fff; border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; margin: 12px 0; }
        .ok { color: #2e7d32; font-weight: bold; }
        .warn { color: #f57c00; font-weight: bold; }
        .err { color: #d32f2f; font-weight: bold; }
        .muted { color: #6b7280; }
        .row { display: flex; gap: 16px; flex-wrap: wrap; }
        .box { flex: 1 1 240px; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; }
        pre { background: #0b1021; color: #d1e7ff; padding: 12px; border-radius: 6px; overflow: auto; max-height: 300px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { text-align: left; border-bottom: 1px solid #eee; padding: 6px 8px; }
        .tag { display: inline-block; padding: 2px 6px; border-radius: 6px; background: #eef2ff; color: #1e40af; font-size: 12px; }
        .small { font-size: 12px; }
    </style>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <script>
    async function fetchAllProducts(apiBase) {
        const all = [];
        let start = 0;
        const limit = 1000;
        while (true) {
            const url = `${apiBase}/api/products?start=${start}&limit=${limit}`;
            const resp = await fetch(url, { cache: 'no-store' });
            if (!resp.ok) throw new Error(`API ${resp.status}`);
            const data = await resp.json();
            const page = Array.isArray(data.products) ? data.products : [];
            all.push(...page);
            if (!data.hasMore) break;
            start += limit;
        }
        return all;
    }

    async function readReferenceList(path) {
        const resp = await fetch(path, { cache: 'no-store' });
        if (!resp.ok) throw new Error(`KB ${resp.status}`);
        const text = await resp.text();
        return text.split('\n')
            .filter(l => l.trim().startsWith('- '))
            .map(l => l.replace(/^\s*-\s+/, '').trim())
            .filter(Boolean);
    }

    function normalizeExact(s) {
        return (s || '').toLowerCase().trim();
    }
    function normalizeLoose(s) {
        return (s || '')
            .toLowerCase()
            .replace(/[._/\\-]+/g, ' ')   // слэши/дефисы/точки в пробел
            .replace(/\s+/g, ' ')          // сжать пробелы
            .replace(/[^a-z0-9а-яёіїєґ\s]/gi, '') // убрать пунктуацию
            .trim();
    }

    function renderList(container, items) {
        container.innerHTML = '';
        if (!items || items.length === 0) {
            container.innerHTML = '<div class="muted small">— пусто —</div>';
            return;
        }
        const ul = document.createElement('ul');
        items.forEach(i => {
            const li = document.createElement('li');
            li.textContent = i;
            ul.appendChild(li);
        });
        container.appendChild(ul);
    }

    async function runCheck() {
        const btn = document.getElementById('runBtn');
        btn.disabled = true;
        const apiBase = document.getElementById('apiBase').value.trim() || 'http://localhost:8000';

        const refBox = document.getElementById('refBox');
        const apiBox = document.getElementById('apiBox');
        const dupTable = document.getElementById('dupTable');
        const missList = document.getElementById('missList');
        const summary = document.getElementById('summary');

        refBox.textContent = 'Загружаем эталон...';
        apiBox.textContent = 'Загружаем товары из API...';
        dupTable.innerHTML = '';
        missList.innerHTML = '';
        summary.innerHTML = '';

        try {
            const [refList, products] = await Promise.all([
                readReferenceList('KNOWLEDGE_BASE_09_GAUGE.md'),
                fetchAllProducts(apiBase)
            ]);

            const refExact = new Set(refList.map(normalizeExact));
            const refLoose = new Set(refList.map(normalizeLoose));
            refBox.innerHTML = `Эталонных позиций: <b>${refList.length}</b> (уникальных по строгому сравнению: <b>${refExact.size}</b>)`;
            apiBox.innerHTML = `Товаров в API: <b>${products.length}</b>`;

            // Совпадения и дубликаты
            const matchedNames = [];
            for (const p of products) {
                const name = p && p.name ? String(p.name) : '';
                if (refExact.has(normalizeExact(name))) matchedNames.push(name);
            }

            const counts = matchedNames.reduce((m, n) => { m[n] = (m[n]||0)+1; return m; }, {});
            const uniqueMatched = Object.keys(counts);
            const duplicates = Object.entries(counts).filter(([,c]) => c > 1).sort((a,b)=> b[1]-a[1] || String(a[0]).localeCompare(String(b[0])));

            // Отсутствующие (loose-нормализация, чтобы учесть вариации написания)
            const matchedLooseSet = new Set(uniqueMatched.map(normalizeLoose));
            const missing = Array.from(refLoose).filter(x => !matchedLooseSet.has(x)).sort();

            // Summary
            const okCount = uniqueMatched.length;
            const missCount = missing.length;
            summary.innerHTML = `
                <div class="row">
                    <div class="box">
                        <div><span class="tag">Уникальных найдено</span></div>
                        <div style="font-size:22px; font-weight:700; margin-top:6px;">${okCount}</div>
                        <div class="small muted">Как на странице (дубликаты не считаем)</div>
                    </div>
                    <div class="box">
                        <div><span class="tag">Дубликаты</span></div>
                        <div style="font-size:22px; font-weight:700; margin-top:6px;">${duplicates.length}</div>
                        <div class="small muted">Товары, встречающиеся более 1 раза</div>
                    </div>
                    <div class="box">
                        <div><span class="tag">Отсутствуют</span></div>
                        <div style="font-size:22px; font-weight:700; margin-top:6px; color:${missCount>0?'#d32f2f':'#2e7d32'}">${missCount}</div>
                        <div class="small muted">Из эталона не попали в API</div>
                    </div>
                </div>
            `;

            // Таблица дубликатов
            if (duplicates.length > 0) {
                const tbl = document.createElement('table');
                const thead = document.createElement('thead');
                thead.innerHTML = '<tr><th style="width:60px;">×</th><th>Название товара</th></tr>';
                tbl.appendChild(thead);
                const tbody = document.createElement('tbody');
                duplicates.forEach(([name, cnt]) => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td><b>${cnt}</b></td><td>${name}</td>`;
                    tbody.appendChild(tr);
                });
                tbl.appendChild(tbody);
                dupTable.appendChild(tbl);
            } else {
                dupTable.innerHTML = '<div class="ok">Дубликатов не найдено.</div>';
            }

            // Список отсутствующих
            renderList(missList, missing);

        } catch (e) {
            summary.innerHTML = `<div class="err">Ошибка: ${e.message || e}</div>`;
        } finally {
            btn.disabled = false;
        }
    }
    </script>
    </head>
<body>
    <h1>Проверка категории: 09 калибр электро</h1>
    <div class="controls">
        <label class="small muted">API Base:&nbsp;</label>
        <input id="apiBase" type="text" value="http://localhost:8000" style="width:260px; padding:6px;">
        <button id="runBtn" onclick="runCheck()">Проверить сейчас</button>
    </div>

    <div class="card">
        <div id="summary" class="muted">Нажмите «Проверить сейчас»</div>
    </div>

    <div class="card">
        <h3>Источник данных</h3>
        <div class="row">
            <div class="box">
                <div><span class="tag">Эталон (KB)</span></div>
                <div id="refBox" class="small muted" style="margin-top:6px;">—</div>
                <div class="small"><a href="KNOWLEDGE_BASE_09_GAUGE.md" target="_blank">Открыть KNOWLEDGE_BASE_09_GAUGE.md</a></div>
            </div>
            <div class="box">
                <div><span class="tag">API</span></div>
                <div id="apiBox" class="small muted" style="margin-top:6px;">—</div>
                <div class="small"><code>/api/products</code> (all pages)</div>
            </div>
        </div>
    </div>

    <div class="card">
        <h3>Дубликаты (если есть)</h3>
        <div id="dupTable">—</div>
    </div>

    <div class="card">
        <h3>Отсутствующие позиции из эталона</h3>
        <div id="missList">—</div>
    </div>

</body>
</html>



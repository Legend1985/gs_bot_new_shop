<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Отладка JavaScript</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug-info { background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .error { background: #ffebee; color: #c62828; }
        .success { background: #e8f5e8; color: #2e7d32; }
        button { background: #2cab37; color: white; border: none; padding: 10px 20px; margin: 5px; border-radius: 4px; cursor: pointer; }
        button:hover { background: #228e2e; }
        .product { border: 1px solid #ccc; margin: 10px; padding: 15px; border-radius: 8px; }
        .product img { max-width: 150px; max-height: 150px; }
    </style>
</head>
<body>
    <h1>Отладка JavaScript кода</h1>
    
    <div class="debug-info">
        <h3>Тестирование функций</h3>
        <button onclick="testFetch()">Тест fetch API</button>
        <button onclick="testCreateCard()">Тест создания карточки</button>
        <button onclick="testLoadFirstPage()">Тест loadFirstPage</button>
        <button onclick="clearResults()">Очистить результаты</button>
    </div>
    
    <div id="results"></div>
    
    <script>
        // Импортируем функции из app.js
        let tg = { WebApp: { expand: () => {}, MainButton: { textColor: '#FFFFFF', color: '#2cab37', text: '', show: () => {} } } };
        
        // Глобальные переменные
        let currentPage = 0;
        let isLoading = false;
        let hasMoreProducts = true;
        const productsPerPage = 60;
        let maxProducts = 0;
        let loadedProductNames = new Set();
        
        function log(message, type = 'info') {
            const resultsDiv = document.getElementById('results');
            const logDiv = document.createElement('div');
            logDiv.className = `debug-info ${type}`;
            logDiv.innerHTML = `<strong>${new Date().toLocaleTimeString()}:</strong> ${message}`;
            resultsDiv.appendChild(logDiv);
            console.log(message);
        }
        
        async function testFetch() {
            log('Начинаем тест fetch API...');
            try {
                const response = await fetch('http://localhost:8000/api.php?start=0&limit=3');
                const data = await response.json();
                log(`API ответ получен: ${data.products ? data.products.length : 0} товаров`, 'success');
                log(`Данные: ${JSON.stringify(data, null, 2)}`);
                
                if (data.products && data.products.length > 0) {
                    displayProducts(data.products);
                }
            } catch (error) {
                log(`Ошибка fetch: ${error.message}`, 'error');
            }
        }
        
        function displayProducts(products) {
            const resultsDiv = document.getElementById('results');
            products.forEach((product, index) => {
                const productDiv = document.createElement('div');
                productDiv.className = 'product';
                productDiv.innerHTML = `
                    <h3>${product.name}</h3>
                    <img src="${product.image}" alt="${product.name}" onerror="this.style.display='none'">
                    <p>Цена: ${product.newPrice} грн</p>
                    <p>Статус: ${product.availability}</p>
                    <p>Рейтинг: ${product.rating}/5</p>
                `;
                resultsDiv.appendChild(productDiv);
            });
        }
        
        function testCreateCard() {
            log('Тестируем создание карточки товара...');
            const testProduct = {
                name: 'Тестовые струны',
                image: 'Goods/Electric_guitar_strings/2221/Ernie_Ball_2221_10-46_150.jpg',
                newPrice: '350',
                oldPrice: '450',
                availability: 'В наличии',
                rating: 4.5
            };
            
            try {
                const card = createProductCardFromSiteData(testProduct, 'testBtn');
                log('Карточка создана успешно', 'success');
                log(`HTML карточки: ${card.outerHTML}`);
            } catch (error) {
                log(`Ошибка создания карточки: ${error.message}`, 'error');
            }
        }
        
        function createProductCardFromSiteData(product, btnId) {
            const card = document.createElement('div');
            card.className = 'product-card';
            
            // Определяем CSS класс для статуса
            let statusClass = '';
            if (product.availability === 'Нет в наличии') {
                statusClass = 'out-of-stock';
            } else if (product.availability === 'Ожидается') {
                statusClass = 'expected';
            } else if (product.availability === 'Под заказ') {
                statusClass = 'on-order';
            } else if (product.availability === 'Снят с производства') {
                statusClass = 'discontinued';
            }
            
            // Создаем HTML для карточки товара
            card.innerHTML = `
                <div class="product-card-top">
                    <div class="img-container">
                        <img src="${product.image}" alt="${product.name}" class="img">
                    </div>
                    <h3 class="product-title">${product.name}</h3>
                    <div class="product-rating">
                        ${generateRatingStars(product.rating)}
                    </div>
                </div>
                <div class="product-card-bottom">
                    <p class="product-status ${statusClass}">${product.availability}</p>
                    <div class="product-bottom-row">
                        <div class="product-prices">
                            ${product.oldPrice && product.oldPrice !== '0' ? `<span class="old-price">${product.oldPrice} грн</span>` : ''}
                            <span class="new-price">${product.newPrice}</span>
                        </div>
                        <button id="${btnId}" class="btn ${statusClass}">
                            ${product.availability === 'Нет в наличии' ? 'Нет в наличии' : 
                              product.availability === 'Ожидается' ? 'Ожидается' :
                              product.availability === 'Под заказ' ? 'Под заказ' : 
                              product.availability === 'Снят с производства' ? 'Снят с производства' : 'Купить'}
                        </button>
                    </div>
                </div>
            `;
            
            return card;
        }
        
        function generateRatingStars(rating) {
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 >= 0.5;
            const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
            
            let stars = '';
            
            // Полные звезды
            for (let i = 0; i < fullStars; i++) {
                stars += '<span class="star-filled">★</span>';
            }
            
            // Половина звезды
            if (hasHalfStar) {
                stars += '<span class="star-half">☆</span>';
            }
            
            // Пустые звезды
            for (let i = 0; i < emptyStars; i++) {
                stars += '<span class="star-empty">☆</span>';
            }
            
            return stars;
        }
        
        async function testLoadFirstPage() {
            log('Тестируем loadFirstPage...');
            try {
                const data = await fetch('http://localhost:8000/api.php?start=0&limit=3');
                const response = await data.json();
                
                if (response.success && response.products && response.products.length > 0) {
                    log(`Загружено ${response.products.length} товаров`, 'success');
                    
                    // Обновляем глобальные переменные
                    maxProducts = response.products.length;
                    hasMoreProducts = response.products.length > 3;
                    
                    // Сохраняем названия загруженных товаров
                    response.products.forEach(product => {
                        loadedProductNames.add(product.name);
                    });
                    
                    // Отображаем товары
                    displayProducts(response.products);
                    
                    log('loadFirstPage выполнен успешно', 'success');
                } else {
                    log('Нет данных от API', 'error');
                }
            } catch (error) {
                log(`Ошибка loadFirstPage: ${error.message}`, 'error');
            }
        }
        
        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }
        
        // Автоматически тестируем API при загрузке страницы
        window.addEventListener('load', () => {
            log('Страница загружена, начинаем тестирование...');
            testFetch();
        });
    </script>
</body>
</html> 